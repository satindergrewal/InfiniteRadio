<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>drift radio</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0a0a0f;
    color: #e0e0e0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem 1rem;
  }

  h1 {
    font-size: 2.5rem;
    font-weight: 300;
    letter-spacing: 0.3em;
    text-transform: lowercase;
    color: #fff;
    margin-bottom: 0.25rem;
  }

  .subtitle {
    font-size: 0.85rem;
    color: #666;
    letter-spacing: 0.15em;
    margin-bottom: 2rem;
  }

  .now-playing {
    background: #12121a;
    border: 1px solid #1e1e2e;
    border-radius: 12px;
    padding: 1.5rem 2rem;
    width: 100%;
    max-width: 500px;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  .track-name {
    font-size: 1.1rem;
    font-weight: 500;
    color: #e0e0e0;
    margin-bottom: 0.25rem;
    font-style: italic;
    min-height: 1.4em;
  }

  .genre-label {
    font-size: 1.4rem;
    font-weight: 500;
    color: #a78bfa;
    margin-bottom: 0.5rem;
  }

  .track-time {
    font-size: 0.9rem;
    color: #888;
    font-variant-numeric: tabular-nums;
  }

  .progress-bar {
    width: 100%;
    height: 4px;
    background: #1e1e2e;
    border-radius: 2px;
    margin-top: 0.75rem;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #7c3aed, #a78bfa);
    border-radius: 2px;
    transition: width 2s linear;
    width: 0%;
  }

  .prompt-section {
    width: 100%;
    max-width: 500px;
    margin-bottom: 1.5rem;
  }

  .prompt-toggle {
    font-size: 0.75rem;
    padding: 0.3rem 0.7rem;
    color: #555;
    border-color: #1e1e2e;
    cursor: pointer;
    width: 100%;
    text-align: left;
    background: #0e0e16;
    border-radius: 8px 8px 0 0;
    display: none;
  }

  .prompt-toggle:hover {
    color: #a78bfa;
  }

  .prompt-toggle.has-content {
    display: block;
  }

  .prompt-panel {
    background: #0e0e16;
    border: 1px solid #1e1e2e;
    border-top: none;
    border-radius: 0 0 8px 8px;
    padding: 0.75rem 1rem;
    display: none;
  }

  .prompt-panel.open {
    display: block;
  }

  .prompt-label {
    font-size: 0.65rem;
    color: #555;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 0.25rem;
  }

  .prompt-text {
    font-size: 0.8rem;
    color: #999;
    font-style: italic;
    line-height: 1.5;
    margin-bottom: 0.5rem;
  }

  .prompt-text:last-child {
    margin-bottom: 0;
  }

  .prompt-text.lyrics {
    color: #666;
    font-style: normal;
  }

  .controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    align-items: center;
    flex-wrap: wrap;
    justify-content: center;
  }

  button {
    background: #1e1e2e;
    color: #e0e0e0;
    border: 1px solid #2e2e3e;
    border-radius: 8px;
    padding: 0.6rem 1.2rem;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  button:hover {
    background: #2e2e3e;
    border-color: #7c3aed;
  }

  button:active {
    transform: scale(0.97);
  }

  button.active {
    background: #7c3aed;
    border-color: #7c3aed;
    color: #fff;
  }

  .play-btn {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }

  .play-btn.active {
    background: #7c3aed;
  }

  .rating {
    display: flex;
    gap: 0.5rem;
  }

  .rating button {
    font-size: 1.1rem;
    padding: 0.5rem 0.8rem;
    position: relative;
  }

  .rating button.rated {
    background: #2a1f4e;
    border-color: #7c3aed;
  }

  .rating button .toast {
    position: absolute;
    top: -1.5rem;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.65rem;
    color: #a78bfa;
    opacity: 0;
    transition: opacity 0.3s, top 0.3s;
    pointer-events: none;
  }

  .rating button .toast.show {
    opacity: 1;
    top: -1.8rem;
  }

  .save-btn {
    font-size: 0.85rem;
    padding: 0.5rem 1rem;
  }

  .save-btn.saved {
    background: #1a2e1c;
    border-color: #059669;
    color: #34d399;
  }

  .genre-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 0.5rem;
    width: 100%;
    max-width: 600px;
    margin-bottom: 1.5rem;
  }

  .genre-btn {
    font-size: 0.8rem;
    padding: 0.5rem;
    text-align: center;
    text-transform: lowercase;
  }

  .genre-btn.current {
    background: #7c3aed;
    border-color: #7c3aed;
    color: #fff;
  }

  .dj-status {
    font-size: 0.8rem;
    color: #666;
    text-align: center;
    margin-bottom: 1rem;
  }

  .dj-status span {
    color: #a78bfa;
  }

  .section-label {
    font-size: 0.75rem;
    color: #555;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.5rem;
    width: 100%;
    max-width: 600px;
  }

  .listeners {
    font-size: 0.75rem;
    color: #444;
    margin-top: 1rem;
  }

  /* Stats panel */
  .stats-toggle {
    font-size: 0.75rem;
    padding: 0.4rem 0.8rem;
    color: #666;
    border-color: #1e1e2e;
    margin-bottom: 0.75rem;
  }

  .stats-toggle:hover {
    color: #a78bfa;
  }

  .stats-panel {
    background: #0e0e16;
    border: 1px solid #1e1e2e;
    border-radius: 10px;
    padding: 1rem 1.25rem;
    width: 100%;
    max-width: 500px;
    margin-bottom: 1.5rem;
    display: none;
    font-size: 0.8rem;
  }

  .stats-panel.open {
    display: block;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem 1.5rem;
  }

  .stat-item {
    display: flex;
    justify-content: space-between;
    padding: 0.25rem 0;
    border-bottom: 1px solid #1a1a24;
  }

  .stat-label {
    color: #555;
  }

  .stat-value {
    color: #a78bfa;
    font-variant-numeric: tabular-nums;
  }

  /* Sliders */
  .sliders {
    width: 100%;
    max-width: 500px;
    margin-bottom: 1.5rem;
  }

  .slider-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .slider-label {
    font-size: 0.8rem;
    color: #666;
    min-width: 80px;
  }

  .slider-row input[type="range"] {
    flex: 1;
    accent-color: #7c3aed;
    height: 4px;
    cursor: pointer;
  }

  .slider-value {
    font-size: 0.8rem;
    color: #a78bfa;
    min-width: 40px;
    text-align: right;
    font-variant-numeric: tabular-nums;
  }
</style>
</head>
<body>

<h1>drift</h1>
<p class="subtitle">infinite ai radio</p>

<div class="now-playing">
  <div class="track-name" id="trackName"></div>
  <div class="genre-label" id="genre">waiting...</div>
  <div class="track-time">
    <span id="position">0:00</span> / <span id="duration">0:00</span>
  </div>
  <div class="progress-bar">
    <div class="progress-fill" id="progress"></div>
  </div>
</div>

<div class="prompt-section">
  <button class="prompt-toggle" id="promptToggle" onclick="togglePrompt()">Prompt &amp; Lyrics</button>
  <div class="prompt-panel" id="promptPanel">
    <div class="prompt-label">Caption (sent to ACE-Step)</div>
    <div class="prompt-text" id="promptCaption">--</div>
    <div class="prompt-label">Lyrics</div>
    <div class="prompt-text lyrics" id="promptLyrics">--</div>
  </div>
</div>

<div class="controls">
  <button class="play-btn" id="playBtn" onclick="togglePlay()">&#9654;</button>
  <button onclick="skip()">Skip</button>
  <button class="save-btn" id="saveBtn" onclick="saveTrack()">Save</button>
  <button id="autoDJBtn" class="active" onclick="toggleAutoDJ()">Auto-DJ</button>
  <div class="rating">
    <button id="thumbsUp" onclick="rate(1)">&#128077;<span class="toast" id="toastUp">Liked!</span></button>
    <button id="thumbsDown" onclick="rate(-1)">&#128078;<span class="toast" id="toastDown">Noted</span></button>
  </div>
</div>

<button class="stats-toggle" onclick="toggleStats()">Stats</button>

<div class="stats-panel" id="statsPanel">
  <div class="stats-grid">
    <div class="stat-item"><span class="stat-label">Model</span><span class="stat-value" id="statModel">--</span></div>
    <div class="stat-item"><span class="stat-label">Steps</span><span class="stat-value" id="statSteps">--</span></div>
    <div class="stat-item"><span class="stat-label">Guidance</span><span class="stat-value" id="statGuidance">--</span></div>
    <div class="stat-item"><span class="stat-label">Shift</span><span class="stat-value" id="statShift">--</span></div>
    <div class="stat-item"><span class="stat-label">Format</span><span class="stat-value" id="statFormat">--</span></div>
    <div class="stat-item"><span class="stat-label">Track length</span><span class="stat-value" id="statTrackLen">--</span></div>
    <div class="stat-item"><span class="stat-label">Crossfade</span><span class="stat-value" id="statCrossfade">--</span></div>
    <div class="stat-item"><span class="stat-label">Listeners</span><span class="stat-value" id="statListeners">0</span></div>
    <div class="stat-item"><span class="stat-label">LLM</span><span class="stat-value" id="statLLM">--</span></div>
  </div>
  <div id="captionRow" style="margin-top:0.75rem;padding-top:0.5rem;border-top:1px solid #1a1a24;display:none">
    <div style="font-size:0.7rem;color:#555;margin-bottom:0.25rem">Caption</div>
    <div id="statCaption" style="font-size:0.75rem;color:#888;font-style:italic;line-height:1.4"></div>
  </div>
</div>

<div class="sliders">
  <div class="slider-row">
    <span class="slider-label">Track length</span>
    <input type="range" id="trackDurSlider" min="15" max="180" step="5" value="60">
    <span class="slider-value" id="trackDurValue">60s</span>
  </div>
  <div class="slider-row">
    <span class="slider-label">Crossfade</span>
    <input type="range" id="crossfadeSlider" min="1" max="20" step="1" value="10">
    <span class="slider-value" id="crossfadeValue">10s</span>
  </div>
</div>

<div class="dj-status" id="djStatus">
  Auto-DJ: transitioning in <span id="dwellTime">--</span>s &middot; <span id="queueSize">0</span> tracks buffered
</div>

<p class="section-label">genres</p>
<div class="genre-grid" id="genreGrid"></div>

<p class="listeners" id="listeners"></p>

<audio id="audio" preload="none"></audio>

<script>
const genres = [
  'ambient', 'chillwave', 'lofi hip hop', 'jazz', 'bossa nova',
  'acoustic folk', 'classical', 'cinematic', 'synthwave', 'electronic',
  'drum and bass', 'disco funk', 'indie rock', 'rock'
];

const audio = document.getElementById('audio');
const playBtn = document.getElementById('playBtn');
let playing = false;
let currentTrackId = '';
let currentRating = 0;

// Build genre grid
const grid = document.getElementById('genreGrid');
genres.forEach(g => {
  const btn = document.createElement('button');
  btn.className = 'genre-btn';
  btn.textContent = g;
  btn.onclick = () => setGenre(g);
  btn.id = 'genre-' + g.replace(/\s+/g, '-');
  grid.appendChild(btn);
});

function togglePlay() {
  if (playing) {
    audio.pause();
    audio.src = '';
    playing = false;
    playBtn.innerHTML = '&#9654;';
    playBtn.classList.remove('active');
  } else {
    audio.src = '/stream';
    audio.play().catch(() => {});
    playing = true;
    playBtn.innerHTML = '&#9646;&#9646;';
    playBtn.classList.add('active');
  }
}

function skip() {
  fetch('/api/skip', { method: 'POST' });
}

function setGenre(genre) {
  fetch('/api/genre', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ genre })
  });
}

function toggleAutoDJ() {
  const btn = document.getElementById('autoDJBtn');
  const enabled = !btn.classList.contains('active');
  fetch('/api/autodj', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ enabled })
  });
  btn.classList.toggle('active');
}

function rate(rating) {
  if (currentRating === rating) {
    currentRating = 0;
    document.getElementById('thumbsUp').classList.remove('rated');
    document.getElementById('thumbsDown').classList.remove('rated');
    return;
  }

  currentRating = rating;
  fetch('/api/rate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ rating })
  });

  const upBtn = document.getElementById('thumbsUp');
  const downBtn = document.getElementById('thumbsDown');
  upBtn.classList.toggle('rated', rating === 1);
  downBtn.classList.toggle('rated', rating === -1);

  const toastId = rating === 1 ? 'toastUp' : 'toastDown';
  const toast = document.getElementById(toastId);
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 1200);
}

function saveTrack() {
  const btn = document.getElementById('saveBtn');
  btn.textContent = 'Saving...';

  const a = document.createElement('a');
  a.href = '/api/save';
  a.download = '';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  btn.textContent = 'Saved!';
  btn.classList.add('saved');
  setTimeout(() => {
    btn.textContent = 'Save';
    btn.classList.remove('saved');
  }, 2000);
}

function toggleStats() {
  document.getElementById('statsPanel').classList.toggle('open');
}

function togglePrompt() {
  document.getElementById('promptPanel').classList.toggle('open');
}

// Slider controls
const trackDurSlider = document.getElementById('trackDurSlider');
const crossfadeSlider = document.getElementById('crossfadeSlider');
let configDebounce = null;

trackDurSlider.oninput = () => {
  document.getElementById('trackDurValue').textContent = trackDurSlider.value + 's';
  sendConfig();
};

crossfadeSlider.oninput = () => {
  document.getElementById('crossfadeValue').textContent = crossfadeSlider.value + 's';
  sendConfig();
};

function sendConfig() {
  clearTimeout(configDebounce);
  configDebounce = setTimeout(() => {
    fetch('/api/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        track_duration: parseInt(trackDurSlider.value),
        crossfade: parseFloat(crossfadeSlider.value)
      })
    });
  }, 300);
}

function formatTime(seconds) {
  const m = Math.floor(seconds / 60);
  const s = Math.floor(seconds % 60);
  return m + ':' + String(s).padStart(2, '0');
}

// Poll status every 2 seconds
setInterval(async () => {
  try {
    const resp = await fetch('/api/status');
    const data = await resp.json();

    document.getElementById('genre').textContent = data.genre || 'waiting...';
    document.getElementById('trackName').textContent = data.track_name || '';
    document.getElementById('position').textContent = formatTime(data.position || 0);
    document.getElementById('duration').textContent = formatTime(data.duration || 0);
    document.getElementById('dwellTime').textContent = Math.round(data.dwell_remaining || 0);
    document.getElementById('queueSize').textContent = data.queue_size || 0;

    // Reset rating state when track changes
    if (data.track_id && data.track_id !== currentTrackId) {
      currentTrackId = data.track_id;
      currentRating = 0;
      document.getElementById('thumbsUp').classList.remove('rated');
      document.getElementById('thumbsDown').classList.remove('rated');
    }

    // Progress bar
    if (data.duration > 0) {
      const pct = ((data.position || 0) / data.duration) * 100;
      document.getElementById('progress').style.width = pct + '%';
    }

    // Highlight current genre
    genres.forEach(g => {
      const el = document.getElementById('genre-' + g.replace(/\s+/g, '-'));
      if (el) {
        el.classList.toggle('current', g === data.genre);
      }
    });

    // Auto-DJ button state
    const djBtn = document.getElementById('autoDJBtn');
    djBtn.classList.toggle('active', data.auto_dj);

    // Listener count
    const total = (data.http_listeners || 0) + (data.webrtc_listeners || 0);
    document.getElementById('listeners').textContent =
      total > 0 ? total + ' listener' + (total !== 1 ? 's' : '') + ' connected' : '';

    // Stats panel
    if (data.config) {
      document.getElementById('statModel').textContent = data.config.model || '--';
      document.getElementById('statSteps').textContent = data.config.inference_steps || '--';
      document.getElementById('statGuidance').textContent = data.config.guidance_scale || '--';
      document.getElementById('statShift').textContent = data.config.shift || '--';
      document.getElementById('statFormat').textContent = (data.config.audio_format || '--').toUpperCase();
      document.getElementById('statTrackLen').textContent = data.config.track_duration + 's';
      document.getElementById('statCrossfade').textContent = data.config.crossfade + 's';
      document.getElementById('statListeners').textContent = total;
      document.getElementById('statLLM').textContent = data.config.llm_model || 'off';

      // Sync sliders with server state (only if user isn't dragging)
      if (document.activeElement !== trackDurSlider) {
        trackDurSlider.value = data.config.track_duration;
        document.getElementById('trackDurValue').textContent = data.config.track_duration + 's';
      }
      if (document.activeElement !== crossfadeSlider) {
        crossfadeSlider.value = data.config.crossfade;
        document.getElementById('crossfadeValue').textContent = data.config.crossfade + 's';
      }
    }

    // Caption display in stats (shown when LLM is generating captions)
    if (data.caption) {
      document.getElementById('captionRow').style.display = 'block';
      document.getElementById('statCaption').textContent = data.caption;
    } else {
      document.getElementById('captionRow').style.display = 'none';
    }

    // Prompt & Lyrics panel
    const promptToggle = document.getElementById('promptToggle');
    if (data.caption || data.lyrics) {
      promptToggle.classList.add('has-content');
      document.getElementById('promptCaption').textContent = data.caption || '(static caption)';
      document.getElementById('promptLyrics').textContent = data.lyrics || '--';
    } else {
      promptToggle.classList.remove('has-content');
    }

  } catch (e) {
    // API not ready yet
  }
}, 2000);
</script>

</body>
</html>
